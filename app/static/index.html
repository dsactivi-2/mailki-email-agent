<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mailki Email Agent</title>
<style>
  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface2: #334155;
    --border: #475569;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #eab308;
    --orange: #f97316;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Layout */
  .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px 0; display: flex; flex-direction: column; }
  .sidebar h1 { font-size: 18px; padding: 0 20px 20px; border-bottom: 1px solid var(--border); }
  .sidebar h1 span { color: var(--accent); }
  .sidebar-nav { flex: 1; overflow-y: auto; }
  .nav-item { display: block; padding: 12px 20px; color: var(--text-dim); cursor: pointer; transition: all 0.15s; font-size: 14px; border-left: 3px solid transparent; }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(59,130,246,0.1); }
  .nav-section { font-size: 11px; text-transform: uppercase; color: var(--text-dim); padding: 20px 20px 8px; letter-spacing: 0.5px; }

  .lang-switch { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 4px; }
  .lang-btn { flex: 1; padding: 6px 0; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-size: 12px; font-weight: 500; border-radius: 4px; transition: all 0.15s; }
  .lang-btn:hover { background: var(--surface2); color: var(--text); }
  .lang-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

  .main { margin-left: 220px; padding: 24px 32px; }
  .page { display: none; }
  .page.active { display: block; }

  /* Header */
  .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .page-header h2 { font-size: 22px; font-weight: 600; }

  /* Cards */
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
  .stat-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .stat-card .value.green { color: var(--green); }
  .stat-card .value.blue { color: var(--accent); }
  .stat-card .value.yellow { color: var(--yellow); }
  .stat-card .value.red { color: var(--red); }

  /* Tables */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-dim); background: var(--surface2); letter-spacing: 0.5px; }
  td { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 14px; }
  tr:hover td { background: rgba(255,255,255,0.02); }

  /* Badges */
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-blue { background: rgba(59,130,246,0.15); color: var(--accent); }
  .badge-yellow { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge-gray { background: rgba(148,163,184,0.15); color: var(--text-dim); }
  .badge-orange { background: rgba(249,115,22,0.15); color: var(--orange); }

  /* Buttons */
  .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { background: var(--surface2); }
  .btn-sm { padding: 5px 12px; font-size: 12px; }

  /* Forms */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; }
  .form-group input, .form-group textarea, .form-group select { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; color: var(--text); font-size: 14px; font-family: inherit; }
  .form-group textarea { resize: vertical; min-height: 80px; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 500px; max-width: 90vw; max-height: 80vh; overflow-y: auto; }
  .modal h3 { margin-bottom: 16px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

  /* Misc */
  .empty { text-align: center; padding: 40px; color: var(--text-dim); }
  .refresh-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; }
  .refresh-btn:hover { color: var(--text); }
  .truncate { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--text-dim); }
  .log-line { padding: 6px 16px; font-family: monospace; font-size: 13px; border-bottom: 1px solid var(--border); }
  .log-line:nth-child(odd) { background: rgba(255,255,255,0.01); }
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .status-dot.on { background: var(--green); }
  .status-dot.off { background: var(--red); }
</style>
</head>
<body>

<div class="sidebar">
  <h1><span>Mailki</span> Agent</h1>
  <div class="sidebar-nav">
    <div class="nav-section" data-i18n="nav_overview">Uebersicht</div>
    <div class="nav-item active" data-page="dashboard">Dashboard</div>
    <div class="nav-section" data-i18n="nav_email">E-Mail</div>
    <div class="nav-item" data-page="events" data-i18n="nav_events">Eingehende E-Mails</div>
    <div class="nav-item" data-page="drafts" data-i18n="nav_drafts">Entwuerfe</div>
    <div class="nav-section" data-i18n="nav_management">Verwaltung</div>
    <div class="nav-item" data-page="mailboxes" data-i18n="nav_mailboxes">Postfaecher</div>
    <div class="nav-item" data-page="users" data-i18n="nav_users">Benutzer</div>
    <div class="nav-section">Knowledge Base</div>
    <div class="nav-item" data-page="tones" data-i18n="nav_tones">Tone / Stil</div>
    <div class="nav-item" data-page="signatures" data-i18n="nav_signatures">Signaturen</div>
    <div class="nav-item" data-page="vips">VIPs</div>
    <div class="nav-item" data-page="compliance">Compliance</div>
    <div class="nav-section" data-i18n="nav_system">System</div>
    <div class="nav-item" data-page="settings" data-i18n="nav_settings">Einstellungen</div>
    <div class="nav-item" data-page="logs">Logs</div>
  </div>
  <div class="lang-switch">
    <button class="lang-btn active" onclick="setLang('de')">DE</button>
    <button class="lang-btn" onclick="setLang('bs')">BS</button>
    <button class="lang-btn" onclick="setLang('en')">EN</button>
  </div>
</div>

<div class="main">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="page-header">
      <h2>Dashboard</h2>
      <button class="refresh-btn" onclick="loadDashboard()">&#x21bb;</button>
    </div>
    <div class="stats" id="dashboard-stats"></div>
    <h3 style="margin-bottom:12px" data-i18n="dash_recent">Letzte Entwuerfe</h3>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_subject">Betreff</th><th>Status</th><th data-i18n="th_tone">Ton</th><th data-i18n="th_created">Erstellt</th></tr></thead>
      <tbody id="dashboard-drafts"></tbody></table>
    </div>
  </div>

  <!-- EVENTS -->
  <div class="page" id="page-events">
    <div class="page-header">
      <h2 data-i18n="nav_events">Eingehende E-Mails</h2>
      <div style="display:flex;align-items:center;gap:12px">
        <label style="font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="auto-refresh-toggle" checked onchange="toggleAutoRefresh()"> Auto (30s)
        </label>
        <button class="btn btn-outline btn-sm" onclick="api('/api/ingest','POST').then(()=>loadEvents())" data-i18n="btn_fetch">Jetzt abrufen</button>
        <button class="refresh-btn" onclick="loadEvents()">&#x21bb;</button>
      </div>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_sender">Absender</th><th data-i18n="th_subject">Betreff</th><th data-i18n="th_priority">Prioritaet</th><th data-i18n="th_processed">Verarbeitet</th><th data-i18n="th_received">Empfangen</th></tr></thead>
      <tbody id="events-table"></tbody></table>
    </div>
  </div>

  <!-- DRAFTS -->
  <div class="page" id="page-drafts">
    <div class="page-header">
      <h2 data-i18n="nav_drafts">Entwuerfe</h2>
      <div>
        <button class="btn btn-outline btn-sm" onclick="api('/api/process','POST').then(()=>loadDrafts())" data-i18n="btn_create_new">Neue erstellen</button>
        <button class="btn btn-outline btn-sm" onclick="api('/api/notify','POST').then(()=>loadDrafts())" data-i18n="btn_send_slack">An Slack senden</button>
        <button class="refresh-btn" onclick="loadDrafts()">&#x21bb;</button>
      </div>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_subject">Betreff</th><th>Status</th><th data-i18n="th_tone">Ton</th><th data-i18n="th_created">Erstellt</th></tr></thead>
      <tbody id="drafts-table"></tbody></table>
    </div>
  </div>

  <!-- MAILBOXES -->
  <div class="page" id="page-mailboxes">
    <div class="page-header">
      <h2 data-i18n="nav_mailboxes">Postfaecher</h2>
      <div>
        <button class="btn btn-primary btn-sm" onclick="openMailboxModal()" data-i18n="btn_new_mailbox">+ Neues Postfach</button>
        <button class="refresh-btn" onclick="loadMailboxes()">&#x21bb;</button>
      </div>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th>E-Mail</th><th>Provider</th><th data-i18n="th_gmail_connected">Gmail verbunden</th><th data-i18n="th_last_sync">Letzter Sync</th><th data-i18n="th_action">Aktion</th></tr></thead>
      <tbody id="mailboxes-table"></tbody></table>
    </div>
  </div>

  <!-- USERS -->
  <div class="page" id="page-users">
    <div class="page-header">
      <h2 data-i18n="nav_users">Benutzer</h2>
      <button class="btn btn-primary btn-sm" onclick="openModal('user-modal')" data-i18n="btn_new_user">+ Neuer Benutzer</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_name">Name</th><th>E-Mail</th><th data-i18n="th_role">Rolle</th><th data-i18n="th_created">Erstellt</th></tr></thead>
      <tbody id="users-table"></tbody></table>
    </div>
  </div>

  <!-- TONES -->
  <div class="page" id="page-tones">
    <div class="page-header">
      <h2 data-i18n="nav_tones">Tone / Stil</h2>
      <button class="btn btn-primary btn-sm" onclick="openModal('tone-modal')" data-i18n="btn_new_tone">+ Neuer Ton</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_name">Name</th><th data-i18n="th_description">Beschreibung</th><th data-i18n="th_default">Standard</th></tr></thead>
      <tbody id="tones-table"></tbody></table>
    </div>
  </div>

  <!-- SIGNATURES -->
  <div class="page" id="page-signatures">
    <div class="page-header">
      <h2 data-i18n="nav_signatures">Signaturen</h2>
      <button class="btn btn-primary btn-sm" onclick="openModal('sig-modal')" data-i18n="btn_new_sig">+ Neue Signatur</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_name">Name</th><th data-i18n="th_language">Sprache</th><th data-i18n="th_default">Standard</th></tr></thead>
      <tbody id="signatures-table"></tbody></table>
    </div>
  </div>

  <!-- VIPS -->
  <div class="page" id="page-vips">
    <div class="page-header">
      <h2>VIPs</h2>
      <button class="btn btn-primary btn-sm" onclick="openModal('vip-modal')" data-i18n="btn_new_vip">+ Neuer VIP</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_email_pattern">E-Mail Pattern</th><th data-i18n="th_name">Name</th><th data-i18n="th_priority">Prioritaet</th><th data-i18n="th_instructions">Anweisungen</th></tr></thead>
      <tbody id="vips-table"></tbody></table>
    </div>
  </div>

  <!-- COMPLIANCE -->
  <div class="page" id="page-compliance">
    <div class="page-header">
      <h2 data-i18n="page_compliance">Compliance Regeln</h2>
      <button class="btn btn-primary btn-sm" onclick="openModal('comp-modal')" data-i18n="btn_new_rule">+ Neue Regel</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th data-i18n="th_rule">Regel</th><th data-i18n="th_description">Beschreibung</th><th>Pattern</th><th data-i18n="th_action">Aktion</th></tr></thead>
      <tbody id="compliance-table"></tbody></table>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div class="page-header">
      <h2 data-i18n="nav_settings">Einstellungen</h2>
      <button class="btn btn-primary btn-sm" onclick="saveSettings()" data-i18n="btn_save">Speichern</button>
    </div>
    <div style="display:grid;gap:20px;max-width:700px">

      <div class="table-wrap" style="padding:20px">
        <h3 style="margin-bottom:12px;font-size:15px">OpenAI</h3>
        <div class="form-grid">
          <div class="form-group"><label>API Key</label><input id="set-openai-key" type="password" placeholder="sk-..."></div>
          <div class="form-group"><label data-i18n="lbl_model">Modell</label>
            <select id="set-openai-model">
              <option value="gpt-4o-mini">gpt-4o-mini</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4-turbo">gpt-4-turbo</option>
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-wrap" style="padding:20px">
        <h3 style="margin-bottom:12px;font-size:15px">Google OAuth</h3>
        <div class="form-grid">
          <div class="form-group"><label>Client ID</label><input id="set-google-id" placeholder="123...apps.googleusercontent.com"></div>
          <div class="form-group"><label>Client Secret</label><input id="set-google-secret" type="password" placeholder="GOCSPX-..."></div>
        </div>
      </div>

      <div class="table-wrap" style="padding:20px">
        <h3 style="margin-bottom:12px;font-size:15px">Slack</h3>
        <div class="form-grid">
          <div class="form-group"><label>Bot Token</label><input id="set-slack-token" type="password" placeholder="xoxb-..."></div>
          <div class="form-group"><label>Signing Secret</label><input id="set-slack-secret" type="password" placeholder="7d3ecf..."></div>
          <div class="form-group"><label>Approver User ID</label><input id="set-slack-user" placeholder="U0904E3AAR5"></div>
          <div class="form-group"><label>Approval Channel</label><input id="set-slack-channel" placeholder="#mailki-approvals"></div>
        </div>
      </div>

      <div class="table-wrap" style="padding:20px">
        <h3 style="margin-bottom:12px;font-size:15px" data-i18n="set_general">Allgemein</h3>
        <div class="form-grid">
          <div class="form-group"><label data-i18n="lbl_poll">Poll-Intervall (Minuten)</label><input id="set-poll-interval" type="number" min="1" max="60" placeholder="5"></div>
        </div>
      </div>

      <p style="font-size:12px;color:var(--text-dim)" data-i18n="set_hint">Hinweis: Aenderungen an API-Keys werden sofort aktiv. Bei Secrets wird der aktuelle Wert maskiert angezeigt — nur ueberschrieben wenn du einen neuen Wert eingibst.</p>
    </div>
  </div>

  <!-- LOGS -->
  <div class="page" id="page-logs">
    <div class="page-header">
      <h2 data-i18n="page_logs">System Logs</h2>
      <button class="refresh-btn" onclick="loadLogs()">&#x21bb;</button>
    </div>
    <div class="table-wrap" id="logs-container" style="max-height:600px;overflow-y:auto"></div>
  </div>

</div>

<!-- MODALS -->
<div class="modal-overlay" id="user-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_user">Neuer Benutzer</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="th_name">Name</label><input id="u-name" placeholder="Max Mustermann"></div>
      <div class="form-group"><label>E-Mail</label><input id="u-email" placeholder="max@firma.de"></div>
      <div class="form-group"><label data-i18n="th_role">Rolle</label>
        <select id="u-role"><option value="agent">Agent</option><option value="admin">Admin</option><option value="reviewer">Reviewer</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('user-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createUser()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="tone-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_tone">Neuer Ton</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="th_name">Name</label><input id="t-name" placeholder="Formell"></div>
      <div class="form-group"><label data-i18n="th_description">Beschreibung</label><input id="t-desc" placeholder="Formeller Geschaeftston"></div>
      <div class="form-group full"><label>Prompt Template</label><textarea id="t-prompt" placeholder="Antworte formell und hoeflich..."></textarea></div>
      <div class="form-group"><label data-i18n="th_default">Standard?</label><select id="t-default"><option value="false" data-i18n-opt="no">Nein</option><option value="true" data-i18n-opt="yes">Ja</option></select></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('tone-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createTone()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="sig-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_sig">Neue Signatur</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="th_name">Name</label><input id="s-name" placeholder="Standard DE"></div>
      <div class="form-group"><label data-i18n="th_language">Sprache</label><select id="s-lang"><option value="de">Deutsch</option><option value="en">English</option><option value="bs">Bosanski</option></select></div>
      <div class="form-group full"><label data-i18n="lbl_text_content">Text-Inhalt</label><textarea id="s-text" placeholder="Mit freundlichen Gruessen..."></textarea></div>
      <div class="form-group full"><label data-i18n="lbl_html_content">HTML-Inhalt</label><textarea id="s-html" placeholder="<p>Mit freundlichen Gruessen...</p>"></textarea></div>
      <div class="form-group"><label data-i18n="th_default">Standard?</label><select id="s-default"><option value="false" data-i18n-opt="no">Nein</option><option value="true" data-i18n-opt="yes">Ja</option></select></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('sig-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createSignature()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="vip-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_vip">Neuer VIP</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="th_email_pattern">E-Mail Pattern</label><input id="v-pattern" placeholder="ceo@wichtig.de"></div>
      <div class="form-group"><label data-i18n="th_name">Name</label><input id="v-name" placeholder="CEO Wichtig GmbH"></div>
      <div class="form-group"><label data-i18n="th_priority">Prioritaet</label><select id="v-prio"><option value="high">High</option><option value="critical">Critical</option><option value="normal">Normal</option></select></div>
      <div class="form-group full"><label data-i18n="lbl_special_instr">Spezielle Anweisungen</label><textarea id="v-instr" placeholder="Immer sofort antworten..."></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('vip-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createVip()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="comp-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_rule">Neue Compliance Regel</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="lbl_rule_name">Regelname</label><input id="c-name" placeholder="DSGVO Warnung"></div>
      <div class="form-group"><label data-i18n="th_action">Aktion</label><select id="c-action"><option value="flag">Flag</option><option value="block">Block</option><option value="warn">Warn</option></select></div>
      <div class="form-group full"><label data-i18n="th_description">Beschreibung</label><input id="c-desc" placeholder="Warnung bei personenbezogenen Daten"></div>
      <div class="form-group full"><label>Regex Pattern</label><input id="c-pattern" placeholder="(IBAN|Steuer-?Nr|Sozialversicherung)"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('comp-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createCompliance()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="mailbox-modal">
  <div class="modal">
    <h3 data-i18n="modal_new_mailbox">Neues Postfach</h3>
    <div class="form-grid">
      <div class="form-group"><label data-i18n="lbl_user">Benutzer</label>
        <select id="mb-user"><option value="">...</option></select>
      </div>
      <div class="form-group"><label data-i18n="lbl_email_addr">E-Mail Adresse</label><input id="mb-email" placeholder="info@firma.de"></div>
      <div class="form-group"><label>Provider</label>
        <select id="mb-provider"><option value="gmail">Gmail</option><option value="outlook">Outlook</option><option value="imap">IMAP</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('mailbox-modal')" data-i18n="btn_cancel">Abbrechen</button>
      <button class="btn btn-primary" onclick="createMailbox()" data-i18n="btn_create">Erstellen</button>
    </div>
  </div>
</div>

<script>
// ─── i18n ───────────────────────────────────────────────────
const LANG = {
  de: {
    // Nav
    nav_overview: 'Uebersicht', nav_email: 'E-Mail', nav_events: 'Eingehende E-Mails',
    nav_drafts: 'Entwuerfe', nav_management: 'Verwaltung', nav_mailboxes: 'Postfaecher',
    nav_users: 'Benutzer', nav_tones: 'Tone / Stil', nav_signatures: 'Signaturen',
    nav_system: 'System', nav_settings: 'Einstellungen',
    // Dashboard
    dash_recent: 'Letzte Entwuerfe', stat_emails: 'E-Mails', stat_drafts: 'Entwuerfe',
    stat_pending: 'Warten auf Freigabe', stat_sent: 'Gesendet', stat_mailboxes: 'Postfaecher',
    stat_users: 'Benutzer',
    // Table headers
    th_subject: 'Betreff', th_tone: 'Ton', th_created: 'Erstellt', th_sender: 'Absender',
    th_priority: 'Prioritaet', th_processed: 'Verarbeitet', th_received: 'Empfangen',
    th_name: 'Name', th_role: 'Rolle', th_description: 'Beschreibung', th_default: 'Standard',
    th_language: 'Sprache', th_email_pattern: 'E-Mail Pattern', th_instructions: 'Anweisungen',
    th_rule: 'Regel', th_action: 'Aktion', th_gmail_connected: 'Gmail verbunden',
    th_last_sync: 'Letzter Sync',
    // Buttons
    btn_fetch: 'Jetzt abrufen', btn_create_new: 'Neue erstellen', btn_send_slack: 'An Slack senden',
    btn_new_mailbox: '+ Neues Postfach', btn_new_user: '+ Neuer Benutzer', btn_new_tone: '+ Neuer Ton',
    btn_new_sig: '+ Neue Signatur', btn_new_vip: '+ Neuer VIP', btn_new_rule: '+ Neue Regel',
    btn_save: 'Speichern', btn_cancel: 'Abbrechen', btn_create: 'Erstellen',
    btn_connect_gmail: 'Gmail verbinden',
    // Modals
    modal_new_user: 'Neuer Benutzer', modal_new_tone: 'Neuer Ton', modal_new_sig: 'Neue Signatur',
    modal_new_vip: 'Neuer VIP', modal_new_rule: 'Neue Compliance Regel', modal_new_mailbox: 'Neues Postfach',
    // Pages
    page_compliance: 'Compliance Regeln', page_logs: 'System Logs',
    // Settings
    set_general: 'Allgemein', lbl_model: 'Modell', lbl_poll: 'Poll-Intervall (Minuten)',
    set_hint: 'Hinweis: Aenderungen an API-Keys werden sofort aktiv. Bei Secrets wird der aktuelle Wert maskiert angezeigt — nur ueberschrieben wenn du einen neuen Wert eingibst.',
    // Form labels
    lbl_user: 'Benutzer', lbl_email_addr: 'E-Mail Adresse', lbl_rule_name: 'Regelname',
    lbl_special_instr: 'Spezielle Anweisungen', lbl_text_content: 'Text-Inhalt', lbl_html_content: 'HTML-Inhalt',
    // Dynamic
    yes: 'Ja', no: 'Nein', connected: 'Verbunden',
    empty_drafts: 'Keine Entwuerfe', empty_emails: 'Keine E-Mails. Klicke "Jetzt abrufen".',
    empty_users: 'Keine Benutzer', empty_mailboxes: 'Keine Postfaecher', empty_tones: 'Keine Tones definiert',
    empty_sigs: 'Keine Signaturen definiert', empty_vips: 'Keine VIPs definiert',
    empty_rules: 'Keine Regeln definiert', empty_logs: 'Keine Logs vorhanden',
    logs_loading: 'Logs werden geladen...', logs_error: 'Fehler beim Laden der Logs',
    saved: 'Gespeichert', no_changes: 'Keine Aenderungen',
    err_user_email: 'Bitte Benutzer und E-Mail angeben', err_prefix: 'Fehler',
    no_users: 'Keine Benutzer vorhanden',
  },
  bs: {
    nav_overview: 'Pregled', nav_email: 'E-posta', nav_events: 'Pristigli mailovi',
    nav_drafts: 'Nacrti', nav_management: 'Upravljanje', nav_mailboxes: 'Postanski sanducici',
    nav_users: 'Korisnici', nav_tones: 'Ton / Stil', nav_signatures: 'Potpisi',
    nav_system: 'Sistem', nav_settings: 'Postavke',
    dash_recent: 'Posljednji nacrti', stat_emails: 'E-mailovi', stat_drafts: 'Nacrti',
    stat_pending: 'Ceka odobrenje', stat_sent: 'Poslano', stat_mailboxes: 'Sanducici',
    stat_users: 'Korisnici',
    th_subject: 'Predmet', th_tone: 'Ton', th_created: 'Kreirano', th_sender: 'Posiljalac',
    th_priority: 'Prioritet', th_processed: 'Obradeno', th_received: 'Primljeno',
    th_name: 'Ime', th_role: 'Uloga', th_description: 'Opis', th_default: 'Podrazumijevano',
    th_language: 'Jezik', th_email_pattern: 'E-mail obrazac', th_instructions: 'Instrukcije',
    th_rule: 'Pravilo', th_action: 'Akcija', th_gmail_connected: 'Gmail povezan',
    th_last_sync: 'Zadnja sinhronizacija',
    btn_fetch: 'Preuzmi sada', btn_create_new: 'Kreiraj novi', btn_send_slack: 'Posalji na Slack',
    btn_new_mailbox: '+ Novi sanducic', btn_new_user: '+ Novi korisnik', btn_new_tone: '+ Novi ton',
    btn_new_sig: '+ Novi potpis', btn_new_vip: '+ Novi VIP', btn_new_rule: '+ Novo pravilo',
    btn_save: 'Sacuvaj', btn_cancel: 'Otkazi', btn_create: 'Kreiraj',
    btn_connect_gmail: 'Povezi Gmail',
    modal_new_user: 'Novi korisnik', modal_new_tone: 'Novi ton', modal_new_sig: 'Novi potpis',
    modal_new_vip: 'Novi VIP', modal_new_rule: 'Novo pravilo uskladenosti', modal_new_mailbox: 'Novi sanducic',
    page_compliance: 'Pravila uskladenosti', page_logs: 'Sistemski logovi',
    set_general: 'Opcenito', lbl_model: 'Model', lbl_poll: 'Interval provjere (minute)',
    set_hint: 'Napomena: Promjene API kljuceva su odmah aktivne. Kod tajnih vrijednosti prikazuje se maskirana verzija — prepisuje se samo ako unesete novu.',
    lbl_user: 'Korisnik', lbl_email_addr: 'E-mail adresa', lbl_rule_name: 'Naziv pravila',
    lbl_special_instr: 'Posebne instrukcije', lbl_text_content: 'Tekstualni sadrzaj', lbl_html_content: 'HTML sadrzaj',
    yes: 'Da', no: 'Ne', connected: 'Povezano',
    empty_drafts: 'Nema nacrta', empty_emails: 'Nema e-mailova. Klikni "Preuzmi sada".',
    empty_users: 'Nema korisnika', empty_mailboxes: 'Nema sanducica', empty_tones: 'Nema definisanih tonova',
    empty_sigs: 'Nema definisanih potpisa', empty_vips: 'Nema definisanih VIP-ova',
    empty_rules: 'Nema definisanih pravila', empty_logs: 'Nema logova',
    logs_loading: 'Logovi se ucitavaju...', logs_error: 'Greska pri ucitavanju logova',
    saved: 'Sacuvano', no_changes: 'Nema promjena',
    err_user_email: 'Molimo unesite korisnika i e-mail', err_prefix: 'Greska',
    no_users: 'Nema korisnika',
  },
  en: {
    nav_overview: 'Overview', nav_email: 'Email', nav_events: 'Incoming Emails',
    nav_drafts: 'Drafts', nav_management: 'Management', nav_mailboxes: 'Mailboxes',
    nav_users: 'Users', nav_tones: 'Tone / Style', nav_signatures: 'Signatures',
    nav_system: 'System', nav_settings: 'Settings',
    dash_recent: 'Recent Drafts', stat_emails: 'Emails', stat_drafts: 'Drafts',
    stat_pending: 'Pending Approval', stat_sent: 'Sent', stat_mailboxes: 'Mailboxes',
    stat_users: 'Users',
    th_subject: 'Subject', th_tone: 'Tone', th_created: 'Created', th_sender: 'Sender',
    th_priority: 'Priority', th_processed: 'Processed', th_received: 'Received',
    th_name: 'Name', th_role: 'Role', th_description: 'Description', th_default: 'Default',
    th_language: 'Language', th_email_pattern: 'Email Pattern', th_instructions: 'Instructions',
    th_rule: 'Rule', th_action: 'Action', th_gmail_connected: 'Gmail Connected',
    th_last_sync: 'Last Sync',
    btn_fetch: 'Fetch now', btn_create_new: 'Create new', btn_send_slack: 'Send to Slack',
    btn_new_mailbox: '+ New Mailbox', btn_new_user: '+ New User', btn_new_tone: '+ New Tone',
    btn_new_sig: '+ New Signature', btn_new_vip: '+ New VIP', btn_new_rule: '+ New Rule',
    btn_save: 'Save', btn_cancel: 'Cancel', btn_create: 'Create',
    btn_connect_gmail: 'Connect Gmail',
    modal_new_user: 'New User', modal_new_tone: 'New Tone', modal_new_sig: 'New Signature',
    modal_new_vip: 'New VIP', modal_new_rule: 'New Compliance Rule', modal_new_mailbox: 'New Mailbox',
    page_compliance: 'Compliance Rules', page_logs: 'System Logs',
    set_general: 'General', lbl_model: 'Model', lbl_poll: 'Poll Interval (minutes)',
    set_hint: 'Note: API key changes take effect immediately. Secret values are shown masked — only overwritten when you enter a new value.',
    lbl_user: 'User', lbl_email_addr: 'Email Address', lbl_rule_name: 'Rule Name',
    lbl_special_instr: 'Special Instructions', lbl_text_content: 'Text Content', lbl_html_content: 'HTML Content',
    yes: 'Yes', no: 'No', connected: 'Connected',
    empty_drafts: 'No drafts', empty_emails: 'No emails. Click "Fetch now".',
    empty_users: 'No users', empty_mailboxes: 'No mailboxes', empty_tones: 'No tones defined',
    empty_sigs: 'No signatures defined', empty_vips: 'No VIPs defined',
    empty_rules: 'No rules defined', empty_logs: 'No logs available',
    logs_loading: 'Loading logs...', logs_error: 'Error loading logs',
    saved: 'Saved', no_changes: 'No changes',
    err_user_email: 'Please enter user and email', err_prefix: 'Error',
    no_users: 'No users available',
  },
};

let currentLang = localStorage.getItem('mailki-lang') || 'de';

function t(key) {
  return (LANG[currentLang] && LANG[currentLang][key]) || LANG.de[key] || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('mailki-lang', lang);
  document.documentElement.lang = lang;

  // Update lang buttons
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');

  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });

  // Update select options with data-i18n-opt
  document.querySelectorAll('[data-i18n-opt]').forEach(el => {
    el.textContent = t(el.dataset.i18nOpt);
  });

  // Reload current page to update dynamic content
  const activePage = document.querySelector('.nav-item.active');
  if (activePage) loadPage(activePage.dataset.page);
}

// ─── Core ───────────────────────────────────────────────────
const API = '';
const DATE_LOCALES = { de: 'de-DE', bs: 'bs-BA', en: 'en-GB' };

async function api(path, method='GET', body=null) {
  const opts = { method, headers: {'Content-Type':'application/json'} };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(API + path, opts);
  return r.json();
}

function statusBadge(s) {
  const m = {
    'sent': 'badge-green', 'approved': 'badge-green', 'pending_approval': 'badge-yellow',
    'draft': 'badge-blue', 'rejected': 'badge-red', 'edit_requested': 'badge-orange'
  };
  return `<span class="badge ${m[s]||'badge-gray'}">${s}</span>`;
}

function prioBadge(p) {
  const m = { 'critical': 'badge-red', 'high': 'badge-orange', 'normal': 'badge-blue', 'low': 'badge-gray' };
  return `<span class="badge ${m[p]||'badge-gray'}">${p}</span>`;
}

function fmtDate(d) {
  if (!d) return '-';
  return new Date(d).toLocaleString(DATE_LOCALES[currentLang] || 'de-DE', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
}

// Navigation
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('page-' + el.dataset.page).classList.add('active');
    loadPage(el.dataset.page);
  });
});

let autoRefreshInterval = null;

function loadPage(page) {
  const loaders = {
    dashboard: loadDashboard, events: loadEvents, drafts: loadDrafts,
    mailboxes: loadMailboxes, users: loadUsers, tones: loadTones,
    signatures: loadSignatures, vips: loadVips, compliance: loadCompliance,
    settings: loadSettings, logs: loadLogs
  };
  if (loaders[page]) loaders[page]();
  if (page === 'events') { startAutoRefresh(); } else { stopAutoRefresh(); }
}

function startAutoRefresh() {
  stopAutoRefresh();
  const toggle = document.getElementById('auto-refresh-toggle');
  if (toggle && toggle.checked) { autoRefreshInterval = setInterval(() => loadEvents(), 30000); }
}
function stopAutoRefresh() { if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; } }
function toggleAutoRefresh() { document.getElementById('auto-refresh-toggle').checked ? startAutoRefresh() : stopAutoRefresh(); }

// ─── Page Loaders ───────────────────────────────────────────

async function loadDashboard() {
  const [events, drafts, mailboxes, users] = await Promise.all([
    api('/api/events'), api('/api/drafts'), api('/api/mailboxes'), api('/api/users')
  ]);
  const pending = drafts.filter(d => d.status === 'pending_approval').length;
  const sent = drafts.filter(d => d.status === 'sent').length;

  document.getElementById('dashboard-stats').innerHTML = `
    <div class="stat-card"><div class="label">${t('stat_emails')}</div><div class="value blue">${events.length}</div></div>
    <div class="stat-card"><div class="label">${t('stat_drafts')}</div><div class="value">${drafts.length}</div></div>
    <div class="stat-card"><div class="label">${t('stat_pending')}</div><div class="value yellow">${pending}</div></div>
    <div class="stat-card"><div class="label">${t('stat_sent')}</div><div class="value green">${sent}</div></div>
    <div class="stat-card"><div class="label">${t('stat_mailboxes')}</div><div class="value">${mailboxes.length}</div></div>
    <div class="stat-card"><div class="label">${t('stat_users')}</div><div class="value">${users.length}</div></div>
  `;
  document.getElementById('dashboard-drafts').innerHTML = drafts.slice(0,10).map(d => `
    <tr><td class="truncate">${d.subject||'-'}</td><td>${statusBadge(d.status)}</td><td>${d.tone||'-'}</td><td class="mono">${fmtDate(d.created_at)}</td></tr>
  `).join('') || `<tr><td colspan="4" class="empty">${t('empty_drafts')}</td></tr>`;
}

async function loadEvents() {
  const data = await api('/api/events');
  document.getElementById('events-table').innerHTML = data.map(e => `
    <tr><td>${e.sender}</td><td class="truncate">${e.subject||'-'}</td><td>${prioBadge(e.priority)}</td>
    <td>${e.is_processed ? `<span class="badge badge-green">${t('yes')}</span>` : `<span class="badge badge-yellow">${t('no')}</span>`}</td>
    <td class="mono">${fmtDate(e.received_at)}</td></tr>
  `).join('') || `<tr><td colspan="5" class="empty">${t('empty_emails')}</td></tr>`;
}

async function loadDrafts() {
  const data = await api('/api/drafts');
  document.getElementById('drafts-table').innerHTML = data.map(d => `
    <tr><td class="truncate">${d.subject||'-'}</td><td>${statusBadge(d.status)}</td><td>${d.tone||'-'}</td><td class="mono">${fmtDate(d.created_at)}</td></tr>
  `).join('') || `<tr><td colspan="4" class="empty">${t('empty_drafts')}</td></tr>`;
}

async function loadMailboxes() {
  const data = await api('/api/mailboxes');
  document.getElementById('mailboxes-table').innerHTML = data.map(m => `
    <tr><td>${m.email_address}</td><td>${m.provider}</td>
    <td><span class="status-dot ${m.has_credentials?'on':'off'}"></span>${m.has_credentials ? t('yes') : t('no')}</td>
    <td class="mono">${fmtDate(m.last_sync_at)}</td>
    <td>${!m.has_credentials ? `<a class="btn btn-primary btn-sm" href="${location.origin}/api/auth/google?mailbox_id=${m.id}">${t('btn_connect_gmail')}</a>` : `<span class="badge badge-green">${t('connected')}</span>`}</td></tr>
  `).join('') || `<tr><td colspan="5" class="empty">${t('empty_mailboxes')}</td></tr>`;
}

async function loadUsers() {
  const data = await api('/api/users');
  document.getElementById('users-table').innerHTML = data.map(u => `
    <tr><td>${u.name}</td><td>${u.email}</td><td><span class="badge badge-blue">${u.role}</span></td><td class="mono">${fmtDate(u.created_at)}</td></tr>
  `).join('') || `<tr><td colspan="4" class="empty">${t('empty_users')}</td></tr>`;
}

async function loadTones() {
  const data = await api('/api/kb/tones');
  document.getElementById('tones-table').innerHTML = data.map(x => `
    <tr><td>${x.name}</td><td>${x.description||'-'}</td><td>${x.is_default?`<span class="badge badge-green">${t('yes')}</span>`:'-'}</td></tr>
  `).join('') || `<tr><td colspan="3" class="empty">${t('empty_tones')}</td></tr>`;
}

async function loadSignatures() {
  const data = await api('/api/kb/signatures');
  document.getElementById('signatures-table').innerHTML = data.map(x => `
    <tr><td>${x.name}</td><td>${x.language}</td><td>${x.is_default?`<span class="badge badge-green">${t('yes')}</span>`:'-'}</td></tr>
  `).join('') || `<tr><td colspan="3" class="empty">${t('empty_sigs')}</td></tr>`;
}

async function loadVips() {
  const data = await api('/api/kb/vips');
  document.getElementById('vips-table').innerHTML = data.map(x => `
    <tr><td class="mono">${x.email_pattern}</td><td>${x.name||'-'}</td><td>${prioBadge(x.priority)}</td><td class="truncate">${x.special_instructions||'-'}</td></tr>
  `).join('') || `<tr><td colspan="4" class="empty">${t('empty_vips')}</td></tr>`;
}

async function loadCompliance() {
  const data = await api('/api/kb/compliance');
  document.getElementById('compliance-table').innerHTML = data.map(x => `
    <tr><td>${x.rule_name}</td><td class="truncate">${x.description||'-'}</td><td class="mono">${x.pattern||'-'}</td><td><span class="badge badge-orange">${x.action}</span></td></tr>
  `).join('') || `<tr><td colspan="4" class="empty">${t('empty_rules')}</td></tr>`;
}

async function loadLogs() {
  document.getElementById('logs-container').innerHTML = `<div class="empty">${t('logs_loading')}</div>`;
  try {
    const data = await api('/api/logs?limit=200');
    if (Array.isArray(data) && data.length > 0) {
      document.getElementById('logs-container').innerHTML = data.map(l => {
        const lvlClass = l.level === 'ERROR' ? 'color:var(--red)' : l.level === 'WARNING' ? 'color:var(--yellow)' : '';
        return `<div class="log-line"><span class="mono" style="color:var(--text-dim)">${l.ts}</span> <span style="${lvlClass};font-weight:600">[${l.level}]</span> <span style="color:var(--accent)">${l.logger}</span>: ${l.message}</div>`;
      }).join('');
    } else {
      document.getElementById('logs-container').innerHTML = `<div class="empty">${t('empty_logs')}</div>`;
    }
  } catch(e) {
    document.getElementById('logs-container').innerHTML = `<div class="empty">${t('logs_error')}</div>`;
  }
}

// ─── Create functions ───────────────────────────────────────

async function createUser() {
  await api('/api/users', 'POST', {
    name: document.getElementById('u-name').value,
    email: document.getElementById('u-email').value,
    role: document.getElementById('u-role').value,
  });
  closeModal('user-modal');
  loadUsers();
}

async function createTone() {
  await api('/api/kb/tones', 'POST', {
    name: document.getElementById('t-name').value,
    description: document.getElementById('t-desc').value,
    prompt_template: document.getElementById('t-prompt').value,
    is_default: document.getElementById('t-default').value === 'true',
  });
  closeModal('tone-modal');
  loadTones();
}

async function createSignature() {
  await api('/api/kb/signatures', 'POST', {
    name: document.getElementById('s-name').value,
    content_text: document.getElementById('s-text').value,
    content_html: document.getElementById('s-html').value || document.getElementById('s-text').value,
    language: document.getElementById('s-lang').value,
    is_default: document.getElementById('s-default').value === 'true',
  });
  closeModal('sig-modal');
  loadSignatures();
}

async function createVip() {
  await api('/api/kb/vips', 'POST', {
    email_pattern: document.getElementById('v-pattern').value,
    name: document.getElementById('v-name').value,
    priority: document.getElementById('v-prio').value,
    special_instructions: document.getElementById('v-instr').value,
  });
  closeModal('vip-modal');
  loadVips();
}

async function createCompliance() {
  await api('/api/kb/compliance', 'POST', {
    rule_name: document.getElementById('c-name').value,
    description: document.getElementById('c-desc').value,
    pattern: document.getElementById('c-pattern').value,
    action: document.getElementById('c-action').value,
  });
  closeModal('comp-modal');
  loadCompliance();
}

// ─── Settings ───────────────────────────────────────────────

const SETTINGS_MAP = {
  'OPENAI_API_KEY': 'set-openai-key', 'OPENAI_MODEL': 'set-openai-model',
  'GOOGLE_CLIENT_ID': 'set-google-id', 'GOOGLE_CLIENT_SECRET': 'set-google-secret',
  'SLACK_BOT_TOKEN': 'set-slack-token', 'SLACK_SIGNING_SECRET': 'set-slack-secret',
  'SLACK_APPROVER_USER_ID': 'set-slack-user', 'SLACK_APPROVAL_CHANNEL': 'set-slack-channel',
  'POLL_INTERVAL_MINUTES': 'set-poll-interval',
};

async function loadSettings() {
  const data = await api('/api/settings');
  for (const [key, elId] of Object.entries(SETTINGS_MAP)) {
    const el = document.getElementById(elId);
    if (!el || !data[key]) continue;
    if (el.type === 'password') {
      el.value = '';
      el.placeholder = data[key].is_set ? data[key].value : 'Not set';
    } else {
      el.value = data[key].value;
    }
  }
}

async function saveSettings() {
  const values = {};
  for (const [key, elId] of Object.entries(SETTINGS_MAP)) {
    const el = document.getElementById(elId);
    if (!el) continue;
    const val = el.value.trim();
    if (el.type === 'password' && !val) continue;
    if (val) values[key] = val;
  }
  const result = await api('/api/settings', 'PUT', { settings: values });
  if (result.updated && result.updated.length > 0) {
    alert(t('saved') + ': ' + result.updated.join(', '));
  } else {
    alert(t('no_changes'));
  }
  loadSettings();
}

// ─── Mailbox creation ───────────────────────────────────────

async function openMailboxModal() {
  const users = await api('/api/users');
  const sel = document.getElementById('mb-user');
  sel.innerHTML = users.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('');
  if (users.length === 0) sel.innerHTML = `<option value="">${t('no_users')}</option>`;
  document.getElementById('mb-email').value = '';
  openModal('mailbox-modal');
}

async function createMailbox() {
  const userId = document.getElementById('mb-user').value;
  const email = document.getElementById('mb-email').value;
  const provider = document.getElementById('mb-provider').value;
  if (!userId || !email) { alert(t('err_user_email')); return; }
  try {
    const result = await api(`/api/users/${userId}/mailboxes`, 'POST', { email_address: email, provider: provider });
    if (result.id) { closeModal('mailbox-modal'); loadMailboxes(); }
    else { alert(t('err_prefix') + ': ' + (result.detail || JSON.stringify(result))); }
  } catch(e) { alert(t('err_prefix') + ': ' + e.message); }
}

// ─── Modal helpers ──────────────────────────────────────────

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('active'); });
});

// ─── Init ───────────────────────────────────────────────────
setLang(currentLang);
loadDashboard();
</script>
</body>
</html>
